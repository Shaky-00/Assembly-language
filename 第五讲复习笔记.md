### 第五讲 过程调用

#### 一、栈与栈帧

栈（stack）是自顶向下或自底向上生长的连续存储区间，栈底位置固定。

自顶向下生长的栈：栈底位置是高地址，栈顶位置是低地址

自底向上生长的栈：栈底位置是低地址，栈顶位置是高地址

X86-Linux-32的程序栈是自顶向下生长的栈，栈底地址是0xbffffxxx，栈顶指针是**esp寄存器**，栈单元大小是32位。

栈的作用：传递函数的参数、返回值等；存放函数的局部变量、返回地址

栈帧（stack frame）：分配给一个过程使用的栈空间称为栈帧

#### 二、过程调用指令

**CALL指令**

过程调用，将下一条指令的地址压入栈，跳转到dest所指示的目标地址执行。

```assembly
CALL 	dest
```

**RET指令**

从过程返回，从栈中弹出返回地址，即eip<-pop()，如果有立即数操作数src，则再退栈src字节，即esp = esp + src；跳到返回地址执行。

```assembly
RET		src
```

**PUSH指令**

压栈，栈指针下移一个单元，将操作数src的内容压入该栈单元中

```assembly
PUSH	src
```

指令示例：

```assembly
push	$5
push	%eax
push 	(%eax)
push	%cs
```

**POP指令**

退栈，将栈顶单元的内容传输到dest所在单元，栈指针上移一个单元

```assembly
POP		dest
```

**LEAVE指令**

释放当前栈帧，将ebp寄存器的值传输给esp，然后从栈顶单元恢复ebp寄存器的值，即esp = ebp，ebp = pop()

```assembly
LEAVE
```

#### 三、C语言函数调用

略

#### 四、ABI简介

ABI（Application binary interface，应用程序二进制接口）

主要约定寄存器的使用方式，保存和恢复的义务，参数与返回值的传递方式，栈帧的格式和维护义务。

**X86-Linux-32 ABI**

**参数与返回值约定：**

> · 参数通过栈传递
>
> · 参数的传递顺序是从右向左
>
> · 参数由调用者维护，属于调用者栈帧
>
> · 返回值存放在eax寄存器
>
> · 返回地址存放调用者的栈帧顶部

**寄存器使用约定：**

> · eax保存返回值
>
> · 调用者保存eax、edx、ecx寄存器（被调用者自由使用）
>
> · 被调用者保存ebx、esi、edi寄存器（调用者自由使用）
>
> · ebp和esp是栈帧指针和栈顶指针